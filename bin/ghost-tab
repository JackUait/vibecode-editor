#!/bin/bash
set -e

# Wrap everything in a function so `curl | bash` reads the entire
# script into memory before executing.  Without this, bash reads
# line-by-line from the pipe and `read` consumes script lines as input.
main() {

# Determine where supporting files live
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
_brew_prefix="$(brew --prefix 2>/dev/null || true)"
if [[ -n "$_brew_prefix" && "$SCRIPT_DIR" == "$_brew_prefix/bin" ]]; then
    SHARE_DIR="$_brew_prefix/share/ghost-tab"
else
    SHARE_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

source "$SHARE_DIR/lib/tui.sh"
source "$SHARE_DIR/lib/install.sh"
source "$SHARE_DIR/lib/ghostty-config.sh"
source "$SHARE_DIR/lib/settings-json.sh"
source "$SHARE_DIR/lib/ai-select-tui.sh"
source "$SHARE_DIR/lib/statusline-setup.sh"
source "$SHARE_DIR/lib/notification-setup.sh"
source "$SHARE_DIR/lib/project-actions.sh"
source "$SHARE_DIR/lib/project-actions-tui.sh"
source "$SHARE_DIR/lib/input.sh"

# ---------- OS check ----------
header "Checking platform..."
if [ "$(uname)" != "Darwin" ]; then
  error "This setup script only supports macOS."
  exit 1
fi
success "macOS detected"

# ---------- Homebrew ----------
header "Checking Homebrew..."
if ! command -v brew &>/dev/null; then
  info "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv 2>/dev/null)"
  success "Homebrew installed"
else
  success "Homebrew found"
fi

# ---------- Dependencies ----------
header "Installing dependencies..."
for pkg in tmux lazygit broot; do
  ensure_brew_pkg "$pkg"
done

# ---------- AI Coding Tools ----------
header "Setting up AI coding tools..."
echo ""
echo -e "  Ghost Tab supports multiple AI coding assistants."
echo -e "  Select your preferred AI tool:"
echo ""

# Use TUI to select AI tool
if select_ai_tool_interactive; then
  # Variable set by select_ai_tool_interactive: _selected_ai_tool
  if [[ -z "$_selected_ai_tool" ]]; then
    error "Internal error: TUI did not set AI tool"
    exit 1
  fi
  SELECTED_AI_TOOL="$_selected_ai_tool"

  # Save preference
  AI_TOOL_PREF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
  mkdir -p "$AI_TOOL_PREF_DIR"
  echo "$SELECTED_AI_TOOL" > "$AI_TOOL_PREF_DIR/ai-tool"

  echo ""
  success "Selected AI tool: $SELECTED_AI_TOOL"

  # Install the selected tool
  case "$SELECTED_AI_TOOL" in
    claude)
      ensure_command "claude" "curl -fsSL https://claude.ai/install.sh | bash" \
        "Run 'claude' to authenticate before opening Ghostty." "Claude Code"
      ;;
    codex)
      ensure_command "codex" "brew install --cask codex" "" "Codex CLI"
      ;;
    copilot)
      ensure_command "copilot" "brew install copilot-cli" "" "Copilot CLI"
      ;;
    opencode)
      ensure_command "opencode" "brew install anomalyco/tap/opencode" "" "OpenCode"
      ;;
  esac
else
  info "AI tool selection cancelled"
  exit 1
fi

# ---------- Ghostty ----------
header "Checking Ghostty..."
ensure_cask "ghostty" "Ghostty"

# Verify supporting files exist (will fail if run via curl|bash without clone)
if [ ! -f "$SHARE_DIR/ghostty/claude-wrapper.sh" ] || [ ! -f "$SHARE_DIR/ghostty/config" ] || [ ! -d "$SHARE_DIR/templates" ]; then
  error "Supporting files not found in $SHARE_DIR"
  echo ""
  info "If you ran this via curl|bash, install via Homebrew instead:"
  echo "  brew tap JackUait/ghost-tab https://github.com/JackUait/ghost-tab"
  echo "  brew install ghost-tab"
  echo ""
  info "Or clone the repo:"
  echo "  git clone https://github.com/JackUait/ghost-tab.git"
  echo "  cd ghost-tab && ./bin/ghost-tab"
  exit 1
fi

# ---------- Wrapper script ----------
header "Setting up wrapper script..."
mkdir -p ~/.config/ghostty
ln -sf "$SHARE_DIR/ghostty/claude-wrapper.sh" ~/.config/ghostty/claude-wrapper.sh
success "Linked claude-wrapper.sh in ~/.config/ghostty/"

# Symlink shared libraries (remove old copies if present)
if [ -d "$SHARE_DIR/lib" ]; then
  [ -d ~/.config/ghostty/lib ] && [ ! -L ~/.config/ghostty/lib ] && rm -rf ~/.config/ghostty/lib
  ln -sfn "$SHARE_DIR/lib" ~/.config/ghostty/lib
  success "Linked shared libraries to ~/.config/ghostty/lib/"
fi

# ---------- Ghostty config ----------
header "Setting up Ghostty config..."
GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
WRAPPER_LINE="command = ~/.config/ghostty/claude-wrapper.sh"

if [ -f "$GHOSTTY_CONFIG" ]; then
  warn "Existing Ghostty config found at $GHOSTTY_CONFIG"
  echo ""
  echo -e "  ${_BOLD}1)${_NC} Merge — add the wrapper command to your existing config"
  echo -e "  ${_BOLD}2)${_NC} Backup & replace — save current config and use ours"
  echo ""
  read -rn1 -p "$(echo -e "${_BLUE}Choose (1/2):${_NC} ")" config_choice </dev/tty
  echo ""

  case "$config_choice" in
    1) merge_ghostty_config "$GHOSTTY_CONFIG" "$WRAPPER_LINE" ;;
    2) backup_replace_ghostty_config "$GHOSTTY_CONFIG" "$SHARE_DIR/ghostty/config" ;;
    *) warn "Invalid choice, skipping config setup" ;;
  esac
else
  cp "$SHARE_DIR/ghostty/config" "$GHOSTTY_CONFIG"
  success "Created Ghostty config at $GHOSTTY_CONFIG"
fi

# Migrate from old config location
OLD_PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/vibecode-editor"
NEW_PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
if [ -d "$OLD_PROJECTS_DIR" ] && [ ! -d "$NEW_PROJECTS_DIR" ]; then
  mv "$OLD_PROJECTS_DIR" "$NEW_PROJECTS_DIR"
  info "Migrated config from vibecode-editor to ghost-tab"
fi

# ---------- Projects ----------
header "Setting up projects..."
PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
PROJECTS_FILE="$PROJECTS_DIR/projects"
mkdir -p "$PROJECTS_DIR"

echo ""

while confirm_tui "Add a project?"; do
  if add_project_interactive; then
    # Variables set by add_project_interactive: _add_project_name, _add_project_path
    if [[ -z "$_add_project_name" || -z "$_add_project_path" ]]; then
      error "Internal error: TUI did not set project details"
      continue
    fi
    add_project_to_file "$_add_project_name" "$_add_project_path" "$PROJECTS_FILE"
    success "Added project: $_add_project_name"
  else
    info "Cancelled"
  fi

  echo ""
done

if [ -f "$PROJECTS_FILE" ] && [ -s "$PROJECTS_FILE" ]; then
  success "Projects saved to $PROJECTS_FILE"
else
  info "No projects added. Add them later to $PROJECTS_FILE"
fi

# ---------- Claude Code Status Line ----------
if [ "$SELECTED_AI_TOOL" = "claude" ]; then
  header "Setting up Claude Code status line..."
  CLAUDE_SETTINGS="$HOME/.claude/settings.json"
  setup_statusline "$SHARE_DIR" "$CLAUDE_SETTINGS" "$HOME"
else
  header "Skipping Claude Code status line..."
  info "Status line features are only available with Claude Code"
fi

# Check if selected tool supports sound
_supports_sound=0
[ "$SELECTED_AI_TOOL" = "claude" ] && _supports_sound=1
[ "$SELECTED_AI_TOOL" = "codex" ] && _supports_sound=1
[ "$SELECTED_AI_TOOL" = "opencode" ] && _supports_sound=1

# ---------- Sound Notification ----------
_sound_enabled=0
if [ "$_supports_sound" -eq 1 ]; then
  header "Sound notification..."
  echo ""
  echo -e "  Play a sound when the AI finishes generating"
  echo -e "  and is waiting for your input."
  echo ""

  if confirm_tui "Enable sound notification?"; then
    _sound_enabled=1
  else
    info "Skipping sound notification"
  fi
else
  header "Skipping sound notification..."
  info "Sound notification requires a supported AI tool"
fi

# ---------- Claude Code notification hooks ----------
if [ "$SELECTED_AI_TOOL" = "claude" ]; then
  CLAUDE_SETTINGS="$HOME/.claude/settings.json"
  if [ "$_sound_enabled" -eq 1 ]; then
    setup_sound_notification "$CLAUDE_SETTINGS" "afplay /System/Library/Sounds/Bottle.aiff &"
  fi
fi

# ---------- Codex CLI Features ----------
if [ "$SELECTED_AI_TOOL" = "codex" ] && [ "$_sound_enabled" -eq 1 ]; then
  header "Setting up Codex CLI features..."
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"

  cat > "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/codex-notify.sh" << 'CXEOF'
#!/bin/bash
# Ghost Tab: Codex CLI notify handler (sound)

# Play sound
afplay /System/Library/Sounds/Bottle.aiff &
CXEOF

  chmod +x "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/codex-notify.sh"
  success "Created Codex CLI notify script"

  # Save Codex feature flags
  python3 -c "
import json, os
path = os.path.join(os.environ.get('XDG_CONFIG_HOME', os.path.expanduser('~/.config')), 'ghost-tab', 'codex-features.json')
json.dump({'sound': ${_sound_enabled}}, open(path, 'w'))
print('ok')
"
  success "Saved Codex CLI feature flags"

  # Configure Codex config.toml
  mkdir -p ~/.codex

  if python3 - ~/.codex/config.toml "$_sound_enabled" << 'PYEOF'
import sys, os

config_path = sys.argv[1]
sound = int(sys.argv[2])

lines = []
if os.path.exists(config_path):
    with open(config_path, "r") as f:
        lines = f.readlines()

has_notify = any(l.strip().startswith("notify") for l in lines)
has_tui = any(l.strip() == "[tui]" for l in lines)
has_status = any(l.strip().startswith("status_line") for l in lines)

with open(config_path, "a") as f:
    if not has_notify and sound:
        f.write("\n")
        f.write('notify = "afplay /System/Library/Sounds/Bottle.aiff"\n')

    if not has_tui:
        f.write("\n[tui]\n")

    if not has_status:
        f.write('status_line = ["model-with-reasoning", "git-branch", "context-remaining", "used-tokens"]\n')

print("ok")
PYEOF
  then
    success "Configured Codex CLI (config.toml)"
  else
    warn "Failed to configure Codex CLI config"
  fi
fi

# Codex CLI status line (always configure if Codex is selected)
if [ "$SELECTED_AI_TOOL" = "codex" ]; then
  header "Setting up Codex CLI status line..."
  mkdir -p ~/.codex
  # Only add status_line if not already present
  if [ ! -f ~/.codex/config.toml ] || ! grep -q 'status_line' ~/.codex/config.toml 2>/dev/null; then
    if ! grep -q '^\[tui\]' ~/.codex/config.toml 2>/dev/null; then
      printf '\n[tui]\n' >> ~/.codex/config.toml
    fi
    printf 'status_line = ["model-with-reasoning", "git-branch", "context-remaining", "used-tokens"]\n' >> ~/.codex/config.toml
    success "Codex CLI status line configured (model, branch, context, tokens)"
  else
    success "Codex CLI status line already configured"
  fi
fi

# ---------- OpenCode Features ----------
if [ "$SELECTED_AI_TOOL" = "opencode" ] && [ "$_sound_enabled" -eq 1 ]; then
  header "Setting up OpenCode features..."
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins"
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"

  # Save feature flags
  python3 -c "
import json, os
path = os.path.join(os.environ.get('XDG_CONFIG_HOME', os.path.expanduser('~/.config')), 'ghost-tab', 'opencode-features.json')
json.dump({'sound': ${_sound_enabled}}, open(path, 'w'))
print('ok')
"

  cat > "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins/ghost-tab.ts" << 'OCEOF'
import { spawn } from "child_process"
import { readFileSync } from "fs"
import { join } from "path"
import { homedir } from "os"

const configPath = join(
  process.env.XDG_CONFIG_HOME || join(homedir(), ".config"),
  "ghost-tab",
  "opencode-features.json"
)
let features = { sound: false }
try {
  features = JSON.parse(readFileSync(configPath, "utf-8"))
} catch {}

export const GhostTab = async () => {
  return {
    event: async ({ event }: { event: { type: string; properties?: any } }) => {
      if (event.type === "session.idle") {
        if (features.sound) {
          spawn("afplay", ["/System/Library/Sounds/Bottle.aiff"], { stdio: "ignore" })
        }
      }
    },
  }
}
OCEOF

  success "Created OpenCode plugin"
  success "Saved OpenCode feature flags"
fi

# ---------- Summary ----------
header "Setup complete!"
echo ""
success "Wrapper script:  ~/.config/ghostty/claude-wrapper.sh (symlink)"
success "Ghostty config:  ~/.config/ghostty/config"
_ai_default="$(cat "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/ai-tool" 2>/dev/null)"
success "AI tool:         $(echo "$_ai_default" | sed 's/claude/Claude Code/;s/codex/Codex CLI/;s/copilot/Copilot CLI/;s/opencode/OpenCode/')"
success "Projects file:   $PROJECTS_FILE"
if [ -f ~/.claude/statusline-wrapper.sh ]; then
  success "Status line:     ~/.claude/statusline-wrapper.sh"
fi
if grep -q '"idle_prompt"' ~/.claude/settings.json 2>/dev/null; then
  success "Sound:           Notification on idle"
fi
if [ -f ~/.codex/config.toml ]; then
  success "Codex config:    ~/.codex/config.toml"
fi
if [ -f "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins/ghost-tab.ts" ]; then
  success "OpenCode plugin: ~/.config/opencode/plugins/ghost-tab.ts"
fi
echo ""
info "Open a new Ghostty window to start coding."

} # end main

main "$@"
