#!/bin/bash
set -e

# Wrap everything in a function so `curl | bash` reads the entire
# script into memory before executing.  Without this, bash reads
# line-by-line from the pipe and `read` consumes script lines as input.
main() {

# Determine where supporting files live
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
_brew_prefix="$(brew --prefix 2>/dev/null || true)"
if [[ -n "$_brew_prefix" && "$SCRIPT_DIR" == "$_brew_prefix/bin" ]]; then
    SHARE_DIR="$_brew_prefix/share/ghost-tab"
else
    SHARE_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
fi

source "$SHARE_DIR/lib/tui.sh"
source "$SHARE_DIR/lib/install.sh"
source "$SHARE_DIR/lib/ghostty-config.sh"
source "$SHARE_DIR/lib/settings-json.sh"
source "$SHARE_DIR/lib/ai-select.sh"
source "$SHARE_DIR/lib/statusline-setup.sh"
source "$SHARE_DIR/lib/notification-setup.sh"

# ---------- OS check ----------
header "Checking platform..."
if [ "$(uname)" != "Darwin" ]; then
  error "This setup script only supports macOS."
  exit 1
fi
success "macOS detected"

# ---------- Homebrew ----------
header "Checking Homebrew..."
if ! command -v brew &>/dev/null; then
  info "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv 2>/dev/null)"
  success "Homebrew installed"
else
  success "Homebrew found"
fi

# ---------- Dependencies ----------
header "Installing dependencies..."
for pkg in tmux lazygit broot; do
  ensure_brew_pkg "$pkg"
done

# ---------- AI Coding Tools ----------
header "Setting up AI coding tools..."
echo ""
echo -e "  Ghost Tab supports multiple AI coding assistants."
echo -e "  Select which ones to install:"
echo ""

# Detect already installed tools
_cc_installed=0; command -v claude &>/dev/null && _cc_installed=1
_codex_installed=0; command -v codex &>/dev/null && _codex_installed=1
_copilot_installed=0; command -v copilot &>/dev/null && _copilot_installed=1
_oc_installed=0; command -v opencode &>/dev/null && _oc_installed=1

run_ai_tool_select "$_cc_installed" "$_codex_installed" "$_copilot_installed" "$_oc_installed"

echo ""

# Install selected AI tools
[ "$_sel_claude" -eq 1 ] && ensure_command "claude" "curl -fsSL https://claude.ai/install.sh | bash" \
  "Run 'claude' to authenticate before opening Ghostty." "Claude Code"
[ "$_sel_codex" -eq 1 ] && ensure_command "codex" "brew install --cask codex" "" "Codex CLI"
[ "$_sel_copilot" -eq 1 ] && ensure_command "copilot" "brew install copilot-cli" "" "Copilot CLI"
[ "$_sel_opencode" -eq 1 ] && ensure_command "opencode" "brew install anomalyco/tap/opencode" "" "OpenCode"

# Save default AI tool preference
AI_TOOL_PREF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
save_ai_tool_preference "$_sel_claude" "$_sel_codex" "$_sel_copilot" "$_sel_opencode" "$AI_TOOL_PREF_DIR"
success "Default AI tool set to $(cat "$AI_TOOL_PREF_DIR/ai-tool")"

# ---------- Ghostty ----------
header "Checking Ghostty..."
ensure_cask "ghostty" "Ghostty"

# Verify supporting files exist (will fail if run via curl|bash without clone)
if [ ! -f "$SHARE_DIR/ghostty/claude-wrapper.sh" ] || [ ! -f "$SHARE_DIR/ghostty/config" ] || [ ! -d "$SHARE_DIR/templates" ]; then
  error "Supporting files not found in $SHARE_DIR"
  echo ""
  info "If you ran this via curl|bash, install via Homebrew instead:"
  echo "  brew tap JackUait/ghost-tab https://github.com/JackUait/ghost-tab"
  echo "  brew install ghost-tab"
  echo ""
  info "Or clone the repo:"
  echo "  git clone https://github.com/JackUait/ghost-tab.git"
  echo "  cd ghost-tab && ./bin/ghost-tab"
  exit 1
fi

# ---------- Wrapper script ----------
header "Setting up wrapper script..."
mkdir -p ~/.config/ghostty
cp "$SHARE_DIR/ghostty/claude-wrapper.sh" ~/.config/ghostty/claude-wrapper.sh
chmod +x ~/.config/ghostty/claude-wrapper.sh
success "Created claude-wrapper.sh in ~/.config/ghostty/"

# Copy shared libraries
if [ -d "$SHARE_DIR/lib" ]; then
  cp -R "$SHARE_DIR/lib" ~/.config/ghostty/lib
  success "Copied shared libraries to ~/.config/ghostty/lib/"
fi

# ---------- Ghostty config ----------
header "Setting up Ghostty config..."
GHOSTTY_CONFIG="$HOME/.config/ghostty/config"
WRAPPER_LINE="command = ~/.config/ghostty/claude-wrapper.sh"

if [ -f "$GHOSTTY_CONFIG" ]; then
  warn "Existing Ghostty config found at $GHOSTTY_CONFIG"
  echo ""
  echo -e "  ${_BOLD}1)${_NC} Merge — add the wrapper command to your existing config"
  echo -e "  ${_BOLD}2)${_NC} Backup & replace — save current config and use ours"
  echo ""
  read -rn1 -p "$(echo -e "${_BLUE}Choose (1/2):${_NC} ")" config_choice </dev/tty
  echo ""

  case "$config_choice" in
    1) merge_ghostty_config "$GHOSTTY_CONFIG" "$WRAPPER_LINE" ;;
    2) backup_replace_ghostty_config "$GHOSTTY_CONFIG" "$SHARE_DIR/ghostty/config" ;;
    *) warn "Invalid choice, skipping config setup" ;;
  esac
else
  cp "$SHARE_DIR/ghostty/config" "$GHOSTTY_CONFIG"
  success "Created Ghostty config at $GHOSTTY_CONFIG"
fi

# Migrate from old config location
OLD_PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/vibecode-editor"
NEW_PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
if [ -d "$OLD_PROJECTS_DIR" ] && [ ! -d "$NEW_PROJECTS_DIR" ]; then
  mv "$OLD_PROJECTS_DIR" "$NEW_PROJECTS_DIR"
  info "Migrated config from vibecode-editor to ghost-tab"
fi

# ---------- Projects ----------
header "Setting up projects..."
PROJECTS_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"
PROJECTS_FILE="$PROJECTS_DIR/projects"
mkdir -p "$PROJECTS_DIR"

echo ""
read -rn1 -p "$(echo -e "${_BLUE}Add a project? (y/n):${_NC} ")" add_project </dev/tty
echo ""

while [[ "$add_project" =~ ^[yY]$ ]]; do
  read -rp "$(echo -e "${_BLUE}Project name:${_NC} ")" proj_name </dev/tty
  read -rp "$(echo -e "${_BLUE}Project path:${_NC} ")" proj_path </dev/tty

  # Expand ~ to $HOME for validation
  expanded_path="${proj_path/#\~/$HOME}"

  if [ -d "$expanded_path" ]; then
    echo "$proj_name:$expanded_path" >> "$PROJECTS_FILE"
    success "Added $proj_name"
  else
    warn "Path $proj_path does not exist yet — adding anyway"
    echo "$proj_name:$expanded_path" >> "$PROJECTS_FILE"
  fi

  echo ""
  read -rn1 -p "$(echo -e "${_BLUE}Add another? (y/n):${_NC} ")" add_project </dev/tty
  echo ""
done

if [ -f "$PROJECTS_FILE" ] && [ -s "$PROJECTS_FILE" ]; then
  success "Projects saved to $PROJECTS_FILE"
else
  info "No projects added. Add them later to $PROJECTS_FILE"
fi

# ---------- Claude Code Status Line ----------
if [ "$_sel_claude" -eq 1 ]; then
  header "Setting up Claude Code status line..."
  CLAUDE_SETTINGS="$HOME/.claude/settings.json"
  setup_statusline "$SHARE_DIR" "$CLAUDE_SETTINGS" "$HOME"
else
  header "Skipping Claude Code status line..."
  info "Status line features are only available with Claude Code"
fi

# Check if any selected tool supports sound/spinner
_supports_sound=0
_supports_spinner=0
[ "$_sel_claude" -eq 1 ] && { _supports_sound=1; _supports_spinner=1; }
[ "$_sel_codex" -eq 1 ] && { _supports_sound=1; _supports_spinner=1; }
[ "$_sel_opencode" -eq 1 ] && { _supports_sound=1; _supports_spinner=1; }

# ---------- Sound Notification ----------
_sound_enabled=0
if [ "$_supports_sound" -eq 1 ]; then
  header "Sound notification..."
  echo ""
  echo -e "  Play a sound when the AI finishes generating"
  echo -e "  and is waiting for your input."
  echo ""
  read -rn1 -p "$(echo -e "${_BLUE}Enable sound notification? (y/n):${_NC} ")" enable_sound </dev/tty
  echo ""

  if [[ "$enable_sound" =~ ^[yY]$ ]]; then
    _sound_enabled=1
  else
    info "Skipping sound notification"
  fi
else
  header "Skipping sound notification..."
  info "Sound notification requires a supported AI tool"
fi

# ---------- Tab Title Animation ----------
_spinner_enabled=0
if [ "$_supports_spinner" -eq 1 ]; then
  header "Tab title animation..."
  echo ""
  echo -e "  Show a spinning animation in the tab title when the AI"
  echo -e "  is waiting for your input."
  echo ""
  read -rn1 -p "$(echo -e "${_BLUE}Enable tab animation? (y/n):${_NC} ")" enable_spinner </dev/tty
  echo ""

  if [[ "$enable_spinner" =~ ^[yY]$ ]]; then
    _spinner_enabled=1
  else
    info "Skipping tab animation"
  fi
else
  header "Skipping tab title animation..."
  info "Tab animation requires a supported AI tool"
fi

# ---------- Claude Code notification hooks ----------
if [ "$_sel_claude" -eq 1 ]; then
  CLAUDE_SETTINGS="$HOME/.claude/settings.json"
  if [ "$_sound_enabled" -eq 1 ]; then
    setup_sound_notification "$CLAUDE_SETTINGS" "afplay /System/Library/Sounds/Bottle.aiff &"
  fi
  if [ "$_spinner_enabled" -eq 1 ]; then
    setup_tab_spinner "$SHARE_DIR" "$CLAUDE_SETTINGS" \
      "bash ~/.claude/tab-spinner-start.sh &" "bash ~/.claude/tab-spinner-stop.sh" "$HOME"
  fi
fi

# ---------- Codex CLI Features ----------
if [ "$_sel_codex" -eq 1 ] && { [ "$_sound_enabled" -eq 1 ] || [ "$_spinner_enabled" -eq 1 ]; }; then
  header "Setting up Codex CLI features..."
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"

  cat > "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/codex-notify.sh" << 'CXEOF'
#!/bin/bash
# Ghost Tab: Codex CLI notify handler (sound + spinner)

PROJECT="${PWD##*/}"
if command -v tmux &>/dev/null && tmux list-sessions &>/dev/null 2>&1; then
  SESSION_NAME=$(tmux display-message -p '#S' 2>/dev/null)
  [ -n "$SESSION_NAME" ] && PROJECT="$SESSION_NAME"
fi

PID_FILE="/tmp/ghost-tab-spinner-${PROJECT}.pid"
FEATURES_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/codex-features.json"

# Kill any running spinner
if [ -f "$PID_FILE" ]; then
  OLD_PID=$(cat "$PID_FILE")
  kill "$OLD_PID" 2>/dev/null
  rm -f "$PID_FILE"
  printf '\033]0;%s\007' "$PROJECT"
fi

# Read feature flags
_sound=0; _spinner=0
if [ -f "$FEATURES_FILE" ]; then
  _sound=$(python3 -c "import json; print(int(json.load(open('$FEATURES_FILE')).get('sound',0)))" 2>/dev/null || echo 0)
  _spinner=$(python3 -c "import json; print(int(json.load(open('$FEATURES_FILE')).get('spinner',0)))" 2>/dev/null || echo 0)
fi

# Play sound
if [ "$_sound" -eq 1 ]; then
  afplay /System/Library/Sounds/Bottle.aiff &
fi

# Start spinner
if [ "$_spinner" -eq 1 ]; then
  FRAMES=(⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏)
  (
    echo $BASHPID > "$PID_FILE"
    i=0
    while true; do
      printf '\033]0;%s %s\007' "${FRAMES[$i]}" "$PROJECT"
      i=$(( (i + 1) % ${#FRAMES[@]} ))
      sleep 0.1
    done
  ) &
  disown
fi
CXEOF

  chmod +x "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/codex-notify.sh"
  success "Created Codex CLI notify script"

  # Save Codex feature flags
  python3 -c "
import json, os
path = os.path.join(os.environ.get('XDG_CONFIG_HOME', os.path.expanduser('~/.config')), 'ghost-tab', 'codex-features.json')
json.dump({'sound': ${_sound_enabled}, 'spinner': ${_spinner_enabled}}, open(path, 'w'))
print('ok')
"
  success "Saved Codex CLI feature flags"

  # Configure Codex config.toml
  mkdir -p ~/.codex

  if python3 - ~/.codex/config.toml "$_sound_enabled" "$_spinner_enabled" << 'PYEOF'
import sys, os

config_path = sys.argv[1]
sound = int(sys.argv[2])
spinner = int(sys.argv[3])

lines = []
if os.path.exists(config_path):
    with open(config_path, "r") as f:
        lines = f.readlines()

has_notify = any(l.strip().startswith("notify") for l in lines)
has_tui = any(l.strip() == "[tui]" for l in lines)
has_status = any(l.strip().startswith("status_line") for l in lines)

with open(config_path, "a") as f:
    if not has_notify and (sound or spinner):
        f.write("\n")
        if spinner:
            f.write('notify = ["bash", "~/.config/ghost-tab/codex-notify.sh"]\n')
        else:
            f.write('notify = ["afplay", "/System/Library/Sounds/Bottle.aiff"]\n')

    if not has_tui:
        f.write("\n[tui]\n")

    if not has_status:
        f.write('status_line = ["model-with-reasoning", "git-branch", "context-remaining", "used-tokens"]\n')

print("ok")
PYEOF
  then
    success "Configured Codex CLI (config.toml)"
  else
    warn "Failed to configure Codex CLI config"
  fi
fi

# Codex CLI status line (always configure if Codex is selected)
if [ "$_sel_codex" -eq 1 ]; then
  header "Setting up Codex CLI status line..."
  mkdir -p ~/.codex
  # Only add status_line if not already present
  if [ ! -f ~/.codex/config.toml ] || ! grep -q 'status_line' ~/.codex/config.toml 2>/dev/null; then
    if ! grep -q '^\[tui\]' ~/.codex/config.toml 2>/dev/null; then
      printf '\n[tui]\n' >> ~/.codex/config.toml
    fi
    printf 'status_line = ["model-with-reasoning", "git-branch", "context-remaining", "used-tokens"]\n' >> ~/.codex/config.toml
    success "Codex CLI status line configured (model, branch, context, tokens)"
  else
    success "Codex CLI status line already configured"
  fi
fi

# ---------- OpenCode Features ----------
if [ "$_sel_opencode" -eq 1 ] && { [ "$_sound_enabled" -eq 1 ] || [ "$_spinner_enabled" -eq 1 ]; }; then
  header "Setting up OpenCode features..."
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins"
  mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab"

  # Save feature flags
  python3 -c "
import json, os
path = os.path.join(os.environ.get('XDG_CONFIG_HOME', os.path.expanduser('~/.config')), 'ghost-tab', 'opencode-features.json')
json.dump({'sound': ${_sound_enabled}, 'spinner': ${_spinner_enabled}}, open(path, 'w'))
print('ok')
"

  cat > "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins/ghost-tab.ts" << 'OCEOF'
import { spawn, execSync } from "child_process"
import { readFileSync, unlinkSync, existsSync } from "fs"
import { join } from "path"
import { tmpdir, homedir } from "os"

const configPath = join(
  process.env.XDG_CONFIG_HOME || join(homedir(), ".config"),
  "ghost-tab",
  "opencode-features.json"
)
let features = { sound: false, spinner: false }
try {
  features = JSON.parse(readFileSync(configPath, "utf-8"))
} catch {}

function getProject(): string {
  try {
    const session = execSync("tmux display-message -p '#S'", {
      stdio: ["pipe", "pipe", "ignore"],
    }).toString().trim()
    if (session) return session
  } catch {}
  return process.cwd().split("/").pop() || "opencode"
}

function getPidFile(): string {
  return join(tmpdir(), `ghost-tab-spinner-${getProject()}.pid`)
}

function killSpinner(): void {
  const pf = getPidFile()
  if (existsSync(pf)) {
    try {
      const pid = parseInt(readFileSync(pf, "utf-8").trim())
      process.kill(pid)
    } catch {}
    try { unlinkSync(pf) } catch {}
    const project = getProject()
    process.stdout.write(`\x1b]0;${project}\x07`)
  }
}

function startSpinner(): void {
  const project = getProject()
  const frames = ["⠋", "⠙", "⠹", "⠸", "⠼", "⠴", "⠦", "⠧", "⠇", "⠏"]
  const script = `
    echo $$ > "${getPidFile()}"
    FRAMES=(${frames.join(" ")})
    i=0
    while true; do
      printf '\\033]0;%s %s\\007' "\${FRAMES[\$i]}" "${project}"
      i=$(( (i + 1) % \${#FRAMES[@]} ))
      sleep 0.1
    done
  `
  const proc = spawn("bash", ["-c", script], { stdio: "ignore", detached: true })
  proc.unref()
}

export const GhostTab = async () => {
  return {
    event: async ({ event }: { event: { type: string; properties?: any } }) => {
      if (event.type === "session.idle") {
        if (features.sound) {
          spawn("afplay", ["/System/Library/Sounds/Bottle.aiff"], { stdio: "ignore" })
        }
        if (features.spinner) {
          killSpinner()
          startSpinner()
        }
      }
      if (event.type === "session.status") {
        const status = event.properties?.status
        if (status?.type === "busy" && features.spinner) {
          killSpinner()
        }
      }
    },
  }
}
OCEOF

  success "Created OpenCode plugin"
  success "Saved OpenCode feature flags"
fi

# ---------- Summary ----------
header "Setup complete!"
echo ""
success "Wrapper script:  ~/.config/ghostty/claude-wrapper.sh"
success "Ghostty config:  ~/.config/ghostty/config"
_ai_default="$(cat "${XDG_CONFIG_HOME:-$HOME/.config}/ghost-tab/ai-tool" 2>/dev/null)"
success "AI tool:         $(echo "$_ai_default" | sed 's/claude/Claude Code/;s/codex/Codex CLI/;s/copilot/Copilot CLI/;s/opencode/OpenCode/')"
success "Projects file:   $PROJECTS_FILE"
if [ -f ~/.claude/statusline-wrapper.sh ]; then
  success "Status line:     ~/.claude/statusline-wrapper.sh"
fi
if grep -q '"idle_prompt"' ~/.claude/settings.json 2>/dev/null; then
  success "Sound:           Notification on idle"
fi
if [ -f ~/.claude/tab-spinner-start.sh ]; then
  success "Tab animation:   Spinner on idle"
fi
if [ -f ~/.codex/config.toml ]; then
  success "Codex config:    ~/.codex/config.toml"
fi
if [ -f "${XDG_CONFIG_HOME:-$HOME/.config}/opencode/plugins/ghost-tab.ts" ]; then
  success "OpenCode plugin: ~/.config/opencode/plugins/ghost-tab.ts"
fi
echo ""
info "Open a new Ghostty window to start coding."

} # end main

main "$@"
